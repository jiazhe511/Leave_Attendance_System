<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>點名系統</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
  label, button { margin-top: 10px; display: block; }
  select, input[type="text"], input[type="date"] { width: 100%; padding: 6px; margin-top: 4px; }
  .student-list { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; margin-top: 10px; }
  .student-item { display: flex; align-items: center; margin-bottom: 4px; }
  .student-item input[type="checkbox"] { margin-right: 8px; }
  .flex-row { display: flex; gap: 10px; }
  .flex-row > * { flex: 1; }
  .btn-inline { display: inline-block; margin-left: 6px; }
  .small-input { width: auto; display: inline-block; }
</style>
</head>
<body>

<h2>點名系統</h2>

<!-- 地區選擇 -->
<label for="regionSelect">選擇地區</label>
<div class="flex-row">
  <select id="regionSelect"></select>
  <input type="text" id="newRegionInput" placeholder="新增地區名稱" />
  <button id="btnAddRegion">新增地區</button>
  <button id="btnDeleteRegion">刪除選中地區</button>
</div>

<!-- 學生管理 -->
<label for="studentList">學生名單</label>
<div class="flex-row">
  <input type="text" id="newStudentInput" placeholder="新增學生姓名" />
  <button id="btnAddStudent">新增學生</button>
  <button id="btnDeleteStudents">刪除選中學生</button>
</div>

<div id="studentList" class="student-list"></div>

<!-- 日期範圍 -->
<label for="startDate">起始日期</label>
<input type="date" id="startDate" />

<label for="endDate">結束日期</label>
<input type="date" id="endDate" />

<button id="btnSubmitAttendance" style="margin-top: 15px;">送出點名</button>

<div id="message" style="margin-top:15px; color: green;"></div>

<script>
  const scriptUrl = "https://script.google.com/macros/s/AKfycbyF8ssCrgS6FUfjFjdBpfJcaK3kUDLv2zEEwOgFf7NuEfdNS8xjqtxAre6uzoCCh6BR/exec";

  const regionSelect = document.getElementById("regionSelect");
  const newRegionInput = document.getElementById("newRegionInput");
  const btnAddRegion = document.getElementById("btnAddRegion");
  const btnDeleteRegion = document.getElementById("btnDeleteRegion");

  const studentListDiv = document.getElementById("studentList");
  const newStudentInput = document.getElementById("newStudentInput");
  const btnAddStudent = document.getElementById("btnAddStudent");
  const btnDeleteStudents = document.getElementById("btnDeleteStudents");

  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");

  const btnSubmitAttendance = document.getElementById("btnSubmitAttendance");

  const messageDiv = document.getElementById("message");

  // 取得今天日期字串 YYYY-MM-DD
  function todayStr() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
  }

  startDateInput.value = todayStr();
  endDateInput.value = todayStr();

  // 載入地區清單
  async function loadRegions() {
    const res = await fetch(scriptUrl + "?type=regions");
    const regions = await res.json();
    regionSelect.innerHTML = "";
    if(Array.isArray(regions)) {
      regions.forEach(r => {
        const option = document.createElement("option");
        option.value = r;
        option.textContent = r;
        regionSelect.appendChild(option);
      });
    }
    if(regionSelect.options.length > 0) {
      regionSelect.selectedIndex = 0;
      loadStudents(regionSelect.value);
    } else {
      studentListDiv.innerHTML = "<i>尚無地區，請新增地區</i>";
    }
  }

  // 新增地區
  btnAddRegion.addEventListener("click", async () => {
    const newRegion = newRegionInput.value.trim();
    if(!newRegion) return alert("請輸入地區名稱");
    const res = await fetch(scriptUrl, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({type:"addRegion", region: newRegion})
    });
    const data = await res.json();
    if(data.success){
      messageDiv.textContent = data.message;
      newRegionInput.value = "";
      await loadRegions();
    } else {
      alert("新增地區失敗：" + data.message);
    }
  });

  // 刪除地區
  btnDeleteRegion.addEventListener("click", async () => {
    const selectedRegion = regionSelect.value;
    if(!selectedRegion) return alert("請選擇地區");
    if(!confirm(`確定刪除地區 ${selectedRegion}？此操作不可恢復`)) return;
    const res = await fetch(scriptUrl, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({type:"deleteRegion", region: selectedRegion})
    });
    const data = await res.json();
    if(data.success){
      messageDiv.textContent = data.message;
      await loadRegions();
    } else {
      alert("刪除地區失敗：" + data.message);
    }
  });

  // 載入學生名單
  async function loadStudents(region) {
    if(!region) return;
    const res = await fetch(scriptUrl + "?type=students");
    const allStudents = await res.json();
    const students = allStudents[region] || [];
    studentListDiv.innerHTML = "";
    if(students.length === 0) {
      studentListDiv.innerHTML = "<i>此地區尚無學生，請新增學生</i>";
    }
    students.forEach(name => {
      const div = document.createElement("div");
      div.className = "student-item";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = name;
      div.appendChild(checkbox);
      div.appendChild(document.createTextNode(name));
      studentListDiv.appendChild(div);
    });
  }

  regionSelect.addEventListener("change", () => {
    loadStudents(regionSelect.value);
  });

  // 新增學生
  btnAddStudent.addEventListener("click", async () => {
    const region = regionSelect.value;
    if(!region) return alert("請先選擇地區");
    const studentName = newStudentInput.value.trim();
    if(!studentName) return alert("請輸入學生姓名");
    const res = await fetch(scriptUrl, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({type:"addStudent", region, studentName})
    });
    const data = await res.json();
    if(data.success){
      messageDiv.textContent = data.message;
      newStudentInput.value = "";
      await loadStudents(region);
    } else {
      alert("新增學生失敗：" + data.message);
    }
  });

  // 刪除學生
  btnDeleteStudents.addEventListener("click", async () => {
    const region = regionSelect.value;
    if(!region) return alert("請先選擇地區");
    const checkedBoxes = [...studentListDiv.querySelectorAll("input[type=checkbox]:checked")];
    if(checkedBoxes.length === 0) return alert("請選擇要刪除的學生");
    if(!confirm(`確定刪除選中的學生？此操作不可恢復`)) return;

    for(const cb of checkedBoxes){
      const studentName = cb.value;
      const res = await fetch(scriptUrl, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({type:"deleteStudent", region, studentName})
      });
      const data = await res.json();
      if(!data.success){
        alert(`刪除學生 ${studentName} 失敗：${data.message}`);
        return;
      }
    }
    messageDiv.textContent = "學生刪除成功";
    await loadStudents(region);
  });

  // 點名送出
  btnSubmitAttendance.addEventListener("click", async () => {
    const region = regionSelect.value;
    if(!region) return alert("請先選擇地區");

    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    if(!startDate || !endDate) return alert("請選擇日期區間");
    if(startDate > endDate) return alert("起始日期不可大於結束日期");

    // 取得選中學生
    const checkedBoxes = [...studentListDiv.querySelectorAll("input[type=checkbox]:checked")];
    if(checkedBoxes.length === 0) return alert("請選擇至少一位學生點名");

    // 組裝日期區間的日期陣列
    function getDatesInRange(start, end) {
      const arr = [];
      let dt = new Date(start);
      const dtEnd = new Date(end);
      while(dt <= dtEnd){
        arr.push(dt.toISOString().slice(0,10));
        dt.setDate(dt.getDate() + 1);
      }
      return arr;
    }
    const dateRange = getDatesInRange(startDate, endDate);

    // 組裝 attendanceRecords 格式 { studentName: { dates: [ ... ] }, ... }
    const attendanceRecords = {};
    checkedBoxes.forEach(cb => {
      attendanceRecords[cb.value] = { dates: dateRange };
    });

    messageDiv.style.color = "black";
    messageDiv.textContent = "正在送出點名資料，請稍候...";

    try {
      // 送出點名資料
      let res = await fetch(scriptUrl, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          type: "saveAttendance",
          region,
          attendanceRecords
        })
      });
      let data = await res.json();
      if(!data.success){
        messageDiv.style.color = "red";
        messageDiv.textContent = "點名儲存失敗：" + data.message;
        return;
      }

      // 送出更新統計
      res = await fetch(scriptUrl, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          type: "updateAttendanceSummary",
          region,
          attendanceRecords
        })
      });
      data = await res.json();
      if(!data.success){
        messageDiv.style.color = "red";
        messageDiv.textContent = "更新出席統計失敗：" + data.message;
        return;
      }

      messageDiv.style.color = "green";
      messageDiv.textContent = "點名與統計更新成功！";

    } catch(err) {
      messageDiv.style.color = "red";
      messageDiv.textContent = "發生錯誤：" + err.message;
    }
  });

  // 初始載入
  loadRegions();
</script>

</body>
</html>
