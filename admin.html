<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†å¾Œå°ï¼ˆè«‹å‡èˆ‡é»åç³»çµ±ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* é»åè¡¨æ ¼åŸºæœ¬æ¨£å¼ */
    #attendanceHistoryTable {
      border-collapse: collapse;
      width: 100%;
    }
    #attendanceHistoryTable th,
    #attendanceHistoryTable td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: center;
      user-select: none;
      white-space: nowrap;
    }

    /* é»åè¡¨é ­å›ºå®š */
    #attendanceHistoryTable th {
      position: sticky;
      top: 0;
      background-color: #d1fae5;
      z-index: 20;
    }

    /* é»åç¬¬ä¸€æ¬„å›ºå®š */
    #attendanceHistoryTable th:first-child,
    #attendanceHistoryTable td:first-child {
      position: sticky;
      left: 0;
      background-color: white;
      z-index: 15;
      min-width: 120px;
      max-width: 120px;
      text-align: left;
      font-weight: 600;
    }

    /* é»åè¡¨æ ¼å®¹å™¨ï¼Œå¯æ©«å‘æ»¾å‹• */
    .table-wrapper {
      overflow: auto;              /* æ”¯æ´æ©«å‘èˆ‡ç¸±å‘æ»¾å‹• */
      max-height: 500px;           /* æ§åˆ¶é¡¯ç¤ºå€å¡Šé«˜åº¦ */
      max-width: 100%;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <!-- ç™»å…¥å€ -->
  <div id="loginArea" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-xl font-bold mb-4 text-center">ç®¡ç†è€…ç™»å…¥</h2>
    <form id="loginForm" class="space-y-4">
      <input type="text" id="username" placeholder="å¸³è™Ÿ" class="w-full border p-2 rounded" required />
      <input type="password" id="password" placeholder="å¯†ç¢¼" class="w-full border p-2 rounded" required />
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ç™»å…¥</button>
      <div id="loginMessage" class="text-red-600 mt-2 text-center"></div>
    </form>
  </div>

  <!-- ç®¡ç†ä¸»å€ -->
  <div id="adminArea" class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 hidden">

    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800">ç®¡ç†å¾Œå°ç³»çµ±</h1>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600">ç™»å‡º</button>
    </div>

    <!-- åŠŸèƒ½é¸æ“‡åˆ‡æ› -->
    <div class="mb-6">
      <label for="systemSelect" class="block text-gray-700 font-semibold mb-2">é¸æ“‡åŠŸèƒ½ç³»çµ±</label>
      <select id="systemSelect" class="border p-2 rounded w-full max-w-xs">
        <option value="attendance">é»åç³»çµ±</option>
        <option value="statistics">å‡ºå¸­çµ±è¨ˆ</option>
      </select>
    </div>

      <div id="recordCount" class="mb-4 text-gray-600"></div>

      <div class="table-wrapper">
        <table class="min-w-full border" id="recordTable">
          <thead class="bg-blue-100 text-gray-700 font-semibold">
            <tr>
              <th class="border p-2">å§“å</th>
              <th class="border p-2">åœ°å€</th>
              <th class="border p-2">è«‹å‡æ—¥æœŸ</th>
              <th class="border p-2">è«‹å‡ç†ç”±</th>
              <th class="border p-2">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody class="text-gray-800"></tbody>
        </table>
      </div>
    </div>

    <!-- é»åç³»çµ±å€ -->
    <div id="attendanceSection" style="display:none;">
      <h2 class="text-xl font-bold mb-4 text-green-800">ğŸ“ é»åç³»çµ±</h2>

      
      <div class="mb-4 flex items-center space-x-4 max-w-xs">
        <div>
          <label for="startDate" class="block font-semibold mb-1">èµ·å§‹æ—¥æœŸ</label>
          <input type="date" id="startDate" class="border p-2 rounded w-full" />
        </div>
        <div>
          <label for="endDate" class="block font-semibold mb-1">çµæŸæ—¥æœŸ</label>
          <input type="date" id="endDate" class="border p-2 rounded w-full" />
        </div>
      </div>
      <div class="mb-4 flex items-center space-x-2 max-w-xs">
        <input type="text" id="newStudentName" placeholder="å­¸ç”Ÿå§“å" class="border p-2 rounded flex-grow" />
        <select id="newStudentRegion" class="border p-2 rounded w-32">
          <option value="">é¸æ“‡åœ°å€</option>
          <option value="æœ¬éƒ¨">æœ¬éƒ¨é“é¤¨</option>
          <option value="æ¸…æ°´">æ¸…æ°´é“é¤¨</option>
          <option value="ç¥å²¡">ç¥å²¡é“é¤¨</option>
          <option value="å¤§é›…">å¤§é›…é“é¤¨</option>
          <option value="è±åŸ">è±åŸé“é¤¨</option>
        </select>
        
    </div>
    <button id="addStudentBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">æ–°å¢å­¸ç”Ÿ</button>


      <div class="mb-4 max-w-xs">
        <label for="attendanceRegion" class="block font-semibold mb-2">é¸æ“‡åœ°å€</label>
        <select id="attendanceRegion" class="border p-2 rounded w-full">
          <option value="">è«‹é¸æ“‡</option>
          <option value="æœ¬éƒ¨">æœ¬éƒ¨é“é¤¨</option>
          <option value="æ¸…æ°´">æ¸…æ°´é“é¤¨</option>
          <option value="ç¥å²¡">ç¥å²¡é“é¤¨</option>
          <option value="å¤§é›…">å¤§é›…é“é¤¨</option>
          <option value="è±åŸ">è±åŸé“é¤¨</option>
        </select>
      </div>

      <div class="table-wrapper mb-4">
        <table id="attendanceHistoryTable" class="min-w-full border text-center"></table>
      </div>

      <button id="saveAttendanceBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" disabled>
        å„²å­˜é»å
      </button>

      <div id="attendanceMessage" class="mt-4 font-semibold"></div>
    </div>

    <!-- å‡ºå¸­çµ±è¨ˆå€ -->
    <div id="statisticsSection" style="display:none;">
      <h2 class="text-xl font-bold mb-4 text-purple-800">ğŸ“Š å‡ºå¸­çµ±è¨ˆ</h2>
      <div id="globalStatisticsReminder" class="mb-4 p-3 bg-red-100 border border-red-400 text-red-800 rounded hidden"></div>
      <div class="mb-4 max-w-xs">
        <label for="statisticsRegion" class="block font-semibold mb-2">é¸æ“‡åœ°å€</label>
        <select id="statisticsRegion" class="border p-2 rounded w-full">
          <option value="">è«‹é¸æ“‡</option>
          <option value="æœ¬éƒ¨">æœ¬éƒ¨é“é¤¨</option>
          <option value="æ¸…æ°´">æ¸…æ°´é“é¤¨</option>
          <option value="ç¥å²¡">ç¥å²¡é“é¤¨</option>
          <option value="å¤§é›…">å¤§é›…é“é¤¨</option>
          <option value="è±åŸ">è±åŸé“é¤¨</option>
        </select>
      </div>
      <div id="statisticsReminder"></div>
      <div class="table-wrapper">
        <table class="min-w-full border text-center" id="statisticsTable">
          <thead class="bg-purple-100">
            <tr>
              <th class="border px-2 py-1">å§“å</th>
              <th class="border px-2 py-1">å‡ºå¸­æ—¥æœŸ</th>
              <th class="border px-2 py-1">å‡ºå¸­æ¬¡æ•¸</th>
            </tr>
          </thead>
          <tbody class="text-gray-800"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // ç™»å…¥å€å…ƒç´ 
  const loginArea = document.getElementById('loginArea');
  const adminArea = document.getElementById('adminArea');
  const loginForm = document.getElementById('loginForm');
  const loginMessage = document.getElementById('loginMessage');
  const logoutBtn = document.getElementById('logoutBtn');

  // åŠŸèƒ½åˆ‡æ›å…ƒç´ 
  const systemSelect = document.getElementById('systemSelect');

  // è«‹å‡ç³»çµ±å…ƒç´ 
  const leaveSection = document.getElementById('leaveSection');
      
  // é»åç³»çµ±å…ƒç´ 
  const attendanceSection = document.getElementById('attendanceSection');
  const attendanceRegion = document.getElementById('attendanceRegion');
  const attendanceHistoryTable = document.getElementById('attendanceHistoryTable');
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
  const attendanceMessage = document.getElementById('attendanceMessage');

  // å‡ºå¸­çµ±è¨ˆå…ƒç´ 
  const statisticsSection = document.getElementById('statisticsSection');
  const statisticsRegion = document.getElementById('statisticsRegion');
  const statisticsTableBody = document.getElementById('statisticsTable').querySelector('tbody');

  // ç¯„ä¾‹å­¸ç”Ÿåå–®
  let studentsByRegion = {};

async function loadStudentsFromServer() {
  try {
    const res = await fetch('/students', { credentials: 'include' });
    if (res.ok) {
      studentsByRegion = await res.json();
    }
  } catch (e) {
    console.error('è¼‰å…¥å­¸ç”Ÿåå–®å¤±æ•—', e);
  }
}

  // ç´€éŒ„é»åè³‡æ–™ (region -> student -> [date])
  let attendanceRecords = {};

  // ----------------- ç™»å…¥ç›¸é—œ -----------------
async function checkLoginStatus() {
  try {
    await loadStudentsFromServer(); // ä»éœ€å–å¾—å­¸ç”Ÿåå–®
    loginArea.style.display = 'none';
    adminArea.classList.remove('hidden');

    const lastSystem = localStorage.getItem('lastSystem') || 'attendance';
    systemSelect.value = lastSystem;
    systemSelect.dispatchEvent(new Event('change'));
  } catch {
    loginArea.style.display = 'block';
    adminArea.classList.add('hidden');
  }
}

loginForm.addEventListener('submit', async e => {
  e.preventDefault();
  loginMessage.textContent = '';
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  try {
    const res = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    if (res.ok) {
      loginArea.style.display = 'none';
      adminArea.classList.remove('hidden');

      const lastSystem = localStorage.getItem('lastSystem') || 'attendance';
      systemSelect.value = lastSystem;
      systemSelect.dispatchEvent(new Event('change'));
    } else {
      const data = await res.json();
      loginMessage.textContent = data.message || 'ç™»å…¥å¤±æ•—';
    }
  } catch {
    loginMessage.textContent = 'ç¶²è·¯éŒ¯èª¤';
  }
});

logoutBtn.addEventListener('click', async () => {
  await fetch('/logout', { method: 'POST' });
  adminArea.classList.add('hidden');
  loginArea.style.display = 'block';
  loginMessage.textContent = '';
  loginForm.reset();
});

// ----------------- åŠŸèƒ½ç³»çµ±åˆ‡æ› -----------------
systemSelect.addEventListener("change", () => {
  const val = systemSelect.value;

  // ğŸ‘‰ å„²å­˜ç›®å‰é¸æ“‡åˆ° localStorage
  localStorage.setItem('lastSystem', val);

  // åªä¿ç•™é»åèˆ‡å‡ºå¸­çµ±è¨ˆå…©å€‹å€å¡Š
  attendanceSection.style.display = val === 'attendance' ? 'block' : 'none';
  statisticsSection.style.display = val === 'statistics' ? 'block' : 'none';
  attendanceMessage.textContent = '';

  if (val === 'statistics') {
    renderGlobalStatisticsReminder();
  }
});

// ----------------- é»åç³»çµ± -----------------

// æ—¥æœŸè¼¸å…¥åˆå§‹å€¼è¨­å®š (é è¨­ä»Šå¤©èµ·ç®—7å¤©)
function setDefaultDates() {
  const savedStart = sessionStorage.getItem('attendanceStartDate');
  const savedEnd = sessionStorage.getItem('attendanceEndDate');

  if (savedStart && savedEnd) {
    startDateInput.value = savedStart;
    endDateInput.value = savedEnd;
  } else {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const startStr = `${yyyy}-${mm}-${dd}`;

    const endDate = new Date(today);
    endDate.setDate(endDate.getDate() + 6);
    const endY = endDate.getFullYear();
    const endM = String(endDate.getMonth() + 1).padStart(2, '0');
    const endD = String(endDate.getDate()).padStart(2, '0');
    const endStr = `${endY}-${endM}-${endD}`;

    startDateInput.value = startStr;
    endDateInput.value = endStr;
  }
}




// å–å¾—æ—¥æœŸå€é–“å…§æ‰€æœ‰æ—¥æœŸå­—ä¸²
function getDatesInRange(startStr, endStr) {
  const dates = [];
  const start = new Date(startStr);
  const end = new Date(endStr);
  if (start > end) return dates;

  for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
    dates.push(dt.toISOString().slice(0, 10));
  }
  return dates;
}

// å¾å¾Œç«¯å–å¾—æŒ‡å®šå€åŸŸçš„é»åè³‡æ–™
const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzpcL1TR6_9Y6c0VRQ3Pcv2TVAcgfV0AT-FpT6oHSYobRCuVoRiFzLZLjyThB56d-Jd/exec';

async function fetchAttendanceRecords(region) {
  try {
    const res = await fetch(GOOGLE_SHEET_API_URL);
    if (!res.ok) throw new Error('è®€å–é»åè³‡æ–™å¤±æ•—');
    const data = await res.json();
    return data[region] || {};
  } catch (e) {
    console.error(e);
    return {};
  }
}



// æ¸²æŸ“é»åè¡¨æ ¼ï¼ˆXè»¸æ—¥æœŸï¼ŒYè»¸å­¸ç”Ÿï¼Œæ ¼å­é»æ“Šåˆ‡æ›ï¼‰
async function renderAttendanceHistory(region) {
  attendanceHistoryTable.innerHTML = '';

  const students = studentsByRegion[region] || [];
  if (students.length === 0) {
    attendanceHistoryTable.innerHTML = '<tr><td>ç„¡å­¸ç”Ÿè³‡æ–™</td></tr>';
    return;
  }

  const startStr = startDateInput.value;
  const endStr = endDateInput.value;
  const dates = getDatesInRange(startStr, endStr);
  if (dates.length === 0) {
    attendanceHistoryTable.innerHTML = '<tr><td>èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ</td></tr>';
    return;
  }

  // è¼‰å…¥é»åè³‡æ–™
  attendanceRecords[region] = await fetchAttendanceRecords(region);
  const regionData = attendanceRecords[region] || {};

  // è¡¨é ­
  const thead = document.createElement('thead');
  const trHead = document.createElement('tr');
  const thEmpty = document.createElement('th');
  thEmpty.textContent = '';
  thEmpty.className = 'border px-2 py-1 bg-green-100 sticky top-0 z-10';
  trHead.appendChild(thEmpty);

  dates.forEach(dateStr => {
    const th = document.createElement('th');
    th.textContent = dateStr;
    th.className = 'border px-2 py-1 bg-green-100 sticky top-0 z-10';
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);
  attendanceHistoryTable.appendChild(thead);

  // è¡¨èº«
  const tbody = document.createElement('tbody');
  students.forEach(student => {
    const tr = document.createElement('tr');
    const tdName = document.createElement('td');
    tdName.className = 'border px-2 py-1 font-semibold text-left sticky left-0 bg-white';

    // æ¸…ç©º textContentï¼Œæ”¹ç”¨ appendChild æ–¹å¼å»ºç«‹å…§å®¹
    tdName.textContent = '';

    // å­¸ç”Ÿå§“åæ–‡å­—ç¯€é»
    const nameText = document.createTextNode(student);
    tdName.appendChild(nameText);

    // æ–°å¢ã€Œåˆªé™¤å­¸ç”Ÿã€æŒ‰éˆ•
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'åˆªé™¤å­¸ç”Ÿ';
    deleteBtn.className = 'text-red-600 text-xs ml-2 px-1 py-0.5 rounded border border-red-600 hover:bg-red-600 hover:text-white cursor-pointer';

deleteBtn.addEventListener('click', async () => {
  if (confirm(`ç¢ºå®šåˆªé™¤å­¸ç”Ÿ ${student} å—ï¼Ÿæ­¤å‹•ä½œæœƒç§»é™¤è©²å­¸ç”Ÿçš„æ‰€æœ‰é»åè³‡æ–™ã€‚`)) {
    try {
      const res = await fetch('/students/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ region, studentName: student })
      });
      const data = await res.json();
      if (res.ok) {
        const idx = studentsByRegion[region].indexOf(student);
        if (idx !== -1) studentsByRegion[region].splice(idx, 1);
        if (attendanceRecords[region]) {
          delete attendanceRecords[region][student];
        }
        renderAttendanceHistory(region);
      } else {
        alert(data.message || 'åˆªé™¤å¤±æ•—');
      }
    } catch (e) {
      alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error(e);
    }
  }
});


    tdName.appendChild(deleteBtn);

    tr.appendChild(tdName);

    // å–å¾—å­¸ç”Ÿå‡ºå¸­è³‡æ–™
    let record = regionData[student];
    if (!record || !Array.isArray(record.dates)) {
      record = { dates: [] };
    }

    const attendedDates = record.dates;

    dates.forEach(dateStr => {
      const td = document.createElement('td');
      td.className = 'border px-2 py-1 cursor-pointer select-none user-select-none';

      if (attendedDates.includes(dateStr)) {
        td.classList.add('bg-green-400');
        td.textContent = 'âœ”';
      }

      td.addEventListener('click', () => {
        const idx = attendedDates.indexOf(dateStr);
        if (idx >= 0) {
          attendedDates.splice(idx, 1);
          td.classList.remove('bg-green-400');
          td.textContent = '';
        } else {
          attendedDates.push(dateStr);
          td.classList.add('bg-green-400');
          td.textContent = 'âœ”';
        }

        // å­˜å›è³‡æ–™çµæ§‹
        regionData[student] = { dates: attendedDates };
      });

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  attendanceHistoryTable.appendChild(tbody);
}

// ç•¶é¸æ“‡åœ°å€æ™‚è¼‰å…¥é»åè¡¨æ ¼
attendanceRegion.addEventListener('change', () => {
  const region = attendanceRegion.value;
  attendanceMessage.textContent = '';
  if (!region) {
    attendanceHistoryTable.innerHTML = '';
    saveAttendanceBtn.disabled = true;
    return;
  }
  saveAttendanceBtn.disabled = false;
  renderAttendanceHistory(region);
});

// ç•¶èµ·å§‹æˆ–çµæŸæ—¥æœŸè®Šå‹•æ™‚é‡æ–°æ¸²æŸ“
startDateInput.addEventListener('change', () => {
  sessionStorage.setItem('attendanceStartDate', startDateInput.value);
  if (attendanceRegion.value) renderAttendanceHistory(attendanceRegion.value);
});

endDateInput.addEventListener('change', () => {
  sessionStorage.setItem('attendanceEndDate', endDateInput.value);
  if (attendanceRegion.value) renderAttendanceHistory(attendanceRegion.value);
});


// å„²å­˜é»åè³‡æ–™ï¼Œä¸¦é¡¯ç¤º1ç§’å¾Œè‡ªå‹•æ¶ˆå¤±è¨Šæ¯
saveAttendanceBtn.addEventListener('click', async () => {
  const region = attendanceRegion.value;
  if (!region) {
    attendanceMessage.style.color = 'red';
    attendanceMessage.textContent = 'è«‹é¸æ“‡åœ°å€';
    return;
  }
  try {
    // **æ¨™æº–åŒ–ï¼šæ¯å€‹å­¸ç”Ÿçš„ dates å»é‡ä¸”å¾å°åˆ°å¤§æ’åºï¼ˆèˆŠåˆ°æ–°ï¼‰**
    if (attendanceRecords[region]) {
      for (const student in attendanceRecords[region]) {
        const rec = attendanceRecords[region][student];
        if (rec && Array.isArray(rec.dates)) {
          rec.dates = Array.from(new Set(rec.dates))
            .sort((a, b) => a.localeCompare(b)); // èˆŠåˆ°æ–°
        }
      }
    }

    const payload = {
      region,
      attendanceRecords: attendanceRecords[region] || {}
    };
    const res = await fetch(GOOGLE_SHEET_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
  if (res.ok) {
  attendanceMessage.style.color = 'green';
  attendanceMessage.textContent = data.message || 'é»åè³‡æ–™å·²å„²å­˜';
  setTimeout(() => {
    attendanceMessage.textContent = '';
  }, 1000);

  // ğŸ‘‰ è‹¥ç›®å‰æ­£åœ¨çµ±è¨ˆé ï¼Œä¸¦ä¸”æ˜¯åŒä¸€åœ°å€ï¼Œå°±è§¸ç™¼åˆ·æ–°
  if (systemSelect.value === 'statistics' && statisticsRegion.value === region) {
    statisticsRegion.dispatchEvent(new Event('change'));
  }
}

    else {
      attendanceMessage.style.color = 'red';
      attendanceMessage.textContent = data.message || 'å„²å­˜å¤±æ•—';
    }
  } catch {
    attendanceMessage.style.color = 'red';
    attendanceMessage.textContent = 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
  }
});

// ----------------- å‡ºå¸­çµ±è¨ˆ -----------------

// âœ… å„²å­˜æ¯ä½å­¸ç”Ÿçš„å·²ç¹³è²»æ¬¡æ•¸ï¼ˆæœŸæ•¸ï¼‰åœ¨ sessionStorage
function getPaidPhaseKey(region, student) {
  return `paidPhase_${region}_${student}`;
}
function getPaidPhase(region, student) {
  return parseInt(sessionStorage.getItem(getPaidPhaseKey(region, student)) || '0');
}
function incrementPaidPhase(region, student) {
  const current = getPaidPhase(region, student);
  sessionStorage.setItem(getPaidPhaseKey(region, student), current + 1);
}

// ğŸ‘‰ æ–°å¢åˆ‡æ›é¡¯ç¤ºæ¨¡å¼çš„ä¸‹æ‹‰é¸å–®
if (!document.getElementById('attendanceDisplayMode')) {
  const select = document.createElement('select');
  select.id = 'attendanceDisplayMode';
  select.className = 'border rounded p-1 mb-3';
  select.innerHTML = `
    <option value="current">ç•¶æœŸï¼ˆæœ€å¤š 8 æ¬¡ï¼‰</option>
    <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
  `;
  statisticsSection.insertBefore(select, statisticsSection.querySelector('.table-wrapper'));
  select.addEventListener('change', () => {
    statisticsRegion.dispatchEvent(new Event('change'));
    renderGlobalStatisticsReminder();
  });
}
// åœ°å€çµ±è¨ˆæ¸²æŸ“
statisticsRegion.addEventListener('change', async () => {
  const region = statisticsRegion.value;
  if (!region) {
    statisticsTableBody.innerHTML = '';
    statisticsReminder.innerHTML = '';
    return;
  }

  //é¡¯ç¤ºè¡¨æ ¼ç•¶å‰é¡¯ç¤ºæ¨¡å¼(æ‰€æœ‰/ç•¶æœŸ)
  const mode = document.getElementById('attendanceDisplayMode')?.value || 'current';

  // å–å¾—è©²åœ°å€é»åè³‡æ–™
  const data = await fetchAttendanceRecords(region);

  // æœ‰æ•ˆå­¸ç”Ÿåå–®
  const validStudents = new Set(studentsByRegion[region] || []);

  // âœ… æ¸…ç†ä¸å­˜åœ¨è©²åœ°å€è³‡æ–™ä¸­çš„å­¸ç”Ÿçš„ paidPhase session è³‡æ–™
  for (const key in sessionStorage) {
    if (key.startsWith('paidPhase_')) {
      const [, regionKey, studentKey] = key.split('_');
      if (regionKey === region && (!data[studentKey] || !Array.isArray(data[studentKey].dates))) {
        sessionStorage.removeItem(key);
      }
    }
  }

  // æ•´ç†çµ±è¨ˆè³‡æ–™
const rows = [];

for (const student in data) {
  if (!validStudents.has(student)) continue;

  const rawDates = data[student]?.dates || [];
  const sortedDates = Array.from(new Set(rawDates)).sort((a, b) => a.localeCompare(b));

  // âœ… è‡ªå‹•ä¿®æ­£ paidPhase
  const paidPhaseKey = getPaidPhaseKey(region, student);
  let paidPhase = getPaidPhase(region, student);
  const maxPaidPhase = Math.floor(sortedDates.length / 8);
  if (paidPhase > maxPaidPhase) {
    paidPhase = maxPaidPhase;
    sessionStorage.setItem(paidPhaseKey, paidPhase);
  }

  const start = paidPhase * 8;
  const displayDates = sortedDates.slice(start);

  const count = displayDates.length;

  rows.push({ student, displayDates, count, paidPhase });
}


rows.sort((a, b) => a.student.localeCompare(b.student));

  // æ›´æ–°è¡¨é ­æ¨™ç±¤æ–‡å­—
  const headerRow = document.querySelector('#statisticsTable thead tr');
  const phaseLabel = mode === 'all' ? 'å‡ºå¸­æ¬¡æ•¸ï¼ˆğŸ“˜ å…¨éƒ¨ï¼‰' : 'å‡ºå¸­æ¬¡æ•¸ï¼ˆğŸ“˜ ç•¶æœŸï¼‰';
  if (headerRow && headerRow.children.length >= 3) {
    headerRow.children[2].textContent = phaseLabel;
  }

  // æ¸²æŸ“çµ±è¨ˆè¡¨æ ¼
let html = '';
rows.forEach(r => {
  const currentCount = r.displayDates.length;
  let extraNotice = "";

  if (mode === 'current') {
    if (currentCount === 8) {
      extraNotice = "<br><span class='text-yellow-600 font-semibold'>âš ï¸ å·²é” 8 æ¬¡ï¼Œè«‹ç›¡å¿«ç¹³è²»</span>";
    } else if (currentCount > 8) {
      extraNotice = "<br><span class='text-red-600 font-semibold'>â— å·²è¶…é 8 æ¬¡ï¼Œè«‹ç›¡å¿«ç¹³è²»</span>";
    }
  }

  const countDisplay = mode === 'all'
    ? `${r.count} æ¬¡<br><span class='text-sm text-gray-500'>ğŸ“˜ å…¨éƒ¨è³‡æ–™</span>`
    : `ğŸ“˜ ç¬¬ ${r.paidPhase + 1} æœŸ<br>ğŸŸ¢ å·²å‡ºå¸­ ${currentCount} æ¬¡${extraNotice}`;

  html += `
    <tr>
      <td class="border px-2 py-1">${r.student}</td>
      <td class="border px-2 py-1">${r.displayDates.join('<br>') || 'â€”'}</td>
      <td class="border px-2 py-1">${countDisplay}</td>
    </tr>
  `;
});
statisticsTableBody.innerHTML = html;
renderGlobalStatisticsReminder();

});
// ğŸ‘‰ è™•ç†æŒ‰ä¸‹å·²ç¹³è²»æŒ‰éˆ•ï¼šåƒ…åˆ·æ–°ç•«é¢ï¼Œé¡¯ç¤ºæœ€æ–°8ç­†ï¼ˆä¸å½±éŸ¿è³‡æ–™ï¼‰
function handlePayment(region, student) {
  const data = attendanceRecords[region]?.[student]?.dates || [];

  // âœ… å»é‡ + èˆŠåˆ°æ–°æ’åº
  const uniqueSortedDates = Array.from(new Set(data)).sort((a, b) => a.localeCompare(b));

  const paidPhase = getPaidPhase(region, student);
  const start = paidPhase * 8;

  // âœ… æ­£ç¢ºæŠ“å‡ºç›®å‰ç•¶æœŸçš„è³‡æ–™
  const currentPhaseDates = uniqueSortedDates.slice(start, start + 8);

  if (currentPhaseDates.length < 8) {
    alert(`${student} å°šæœªä¸Šæ»¿ 8 ç¯€èª²ï¼Œç„¡æ³•é€²å…¥ä¸‹ä¸€æœŸ`);
    return;
  }

  if (confirm(`ç¢ºå®š ${student} å·²ç¹³è²»ï¼Ÿç³»çµ±å°‡é¡¯ç¤ºä¸‹ä¸€æœŸï¼ˆ8 æ¬¡ï¼‰å‡ºå¸­è¨˜éŒ„ã€‚`)) {
    incrementPaidPhase(region, student);
    statisticsRegion.dispatchEvent(new Event('change'));
    renderGlobalStatisticsReminder();
  }
}


// ğŸ”” å…¨å€æé†’ + å·²ç¹³è²»æŒ‰éˆ•é¡¯ç¤ºåœ¨ç´…è‰²å€å¡Šä¸­ï¼ˆåƒ…ç•¶æœŸåˆ¤æ–·ï¼‰
async function renderGlobalStatisticsReminder() {
  const globalReminder = document.getElementById("globalStatisticsReminder");

  try {
    const allData = await fetch("/attendance", { credentials: 'include' }).then(r => r.json());
    const mode = document.getElementById('attendanceDisplayMode')?.value || 'current';

    if (mode === 'all') {
      globalReminder.innerHTML = "";
      globalReminder.classList.add("hidden");
      return;
    }

    let reminders = [];

    for (const region in allData) {
      const regionData = allData[region] || {};

      for (const student in regionData) {
        const rawDates = regionData[student]?.dates || [];

        // âœ… å»é‡ä¸¦æ’åºï¼ˆèˆŠåˆ°æ–°ï¼‰
        const uniqueSortedDates = Array.from(new Set(rawDates)).sort((a, b) => a.localeCompare(b));

        const paidPhaseKey = getPaidPhaseKey(region, student);
        let paidPhase = getPaidPhase(region, student);
        const maxPaidPhase = Math.floor(uniqueSortedDates.length / 8);

        // âœ… è‹¥ç¹³è²»æœŸæ•¸è¶…éæœ€å¤§æœŸæ•¸ï¼Œè‡ªå‹•é€€å›
        if (paidPhase > maxPaidPhase) {
          paidPhase = maxPaidPhase;
          sessionStorage.setItem(paidPhaseKey, paidPhase);
        }

        // âœ… å–å¾—ç•¶æœŸå‡ºå¸­è¨˜éŒ„
        const start = paidPhase * 8;
        const displayDates = uniqueSortedDates.slice(start);

        if (displayDates.length >= 7) {
          reminders.push({
            region,
            student,
            count: displayDates.length
          });
        }
      }
    }

    if (reminders.length > 0) {
      globalReminder.innerHTML = `
        <strong class="block mb-2">âš ï¸ å…¨å€å‡ºå¸­æ¬¡æ•¸é” 7 æ¬¡ä»¥ä¸Šåå–®ï¼š</strong>
        ${reminders.map(r => `
          <div class="mb-1 flex items-center gap-2">
            <span>${r.region} - ${r.student}ï¼ˆ${r.count} æ¬¡ï¼‰</span>
            <button class="bg-indigo-600 text-white px-2 py-0.5 text-sm rounded hover:bg-indigo-700"
                    onclick="handlePayment('${r.region}', '${r.student}')">
              å·²ç¹³è²»ï¼ˆé¡¯ç¤ºä¸‹ä¸€æœŸï¼‰
            </button>
          </div>
        `).join('')}
      `;
    } else {
      globalReminder.innerHTML = "<div>ç›®å‰ç„¡éœ€æé†’åå–®</div>";
    }

    globalReminder.classList.remove("hidden");
  } catch (err) {
    globalReminder.innerHTML = "<div>âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—</div>";
    globalReminder.classList.remove("hidden");
    console.error(err);
  }
}

// åŠŸèƒ½åˆ‡æ›é¸å–®ç›£è½
systemSelect.addEventListener("change", () => {
  const val = systemSelect.value;

  leaveSection.style.display = val === 'leave' ? 'block' : 'none';
  attendanceSection.style.display = val === 'attendance' ? 'block' : 'none';
  statisticsSection.style.display = val === 'statistics' ? 'block' : 'none';
  attendanceMessage.textContent = '';

  // è‹¥åˆ‡æ›è‡³çµ±è¨ˆé ï¼Œåˆ·æ–°æé†’
  if (val === 'statistics') {
  renderGlobalStatisticsReminder();
  if (statisticsRegion.value) {
    statisticsRegion.dispatchEvent(new Event('change'));
  }
}

});
// æ–°å¢å­¸ç”ŸæŒ‰éˆ• DOM å…ƒç´ 
const newStudentNameInput = document.getElementById('newStudentName');
const newStudentRegionSelect = document.getElementById('newStudentRegion');
const addStudentBtn = document.getElementById('addStudentBtn');


addStudentBtn.addEventListener('click', async () => {
  const name = newStudentNameInput.value.trim();
  const region = newStudentRegionSelect.value;

  if (!name) {
    alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“å');
    return;
  }
  if (!region) {
    alert('è«‹é¸æ“‡å­¸ç”Ÿåœ°å€');
    return;
  }

  try {
    const res = await fetch('/students/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ region, studentName: name })
    });

    const data = await res.json();
    if (res.ok) {
      alert(data.message || 'æ–°å¢æˆåŠŸ');

      // æ›´æ–°æœ¬åœ°è³‡æ–™çµæ§‹
      if (!studentsByRegion[region]) studentsByRegion[region] = [];
      studentsByRegion[region].push(name);

      if (attendanceRegion.value === region) {
        renderAttendanceHistory(region);
      }

      newStudentNameInput.value = '';
      newStudentRegionSelect.value = '';
    } else {
      alert(data.message || 'æ–°å¢å¤±æ•—');
    }
  } catch (e) {
    alert('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    console.error(e);
  }
});


// é é¢åˆå§‹åŒ–
checkLoginStatus();
renderGlobalStatisticsReminder();
setDefaultDates(); 

</script>
</body>
</html>

